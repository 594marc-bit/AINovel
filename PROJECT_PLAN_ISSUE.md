# AINovel MVP开发计划

## 项目概述
AI小说接龙平台，支持单人/多人协作创作，集成AI续写、润色和向量化存储功能。

## 当前状态

### ✅ 已实现功能

#### 1. 用户认证系统
- 用户注册（邮箱/用户名）
- JWT令牌认证
- 密码哈希存储（bcrypt）
- 用户信息获取接口

#### 2. 小说管理
- 小说创建、读取、更新、删除
- 章节管理（自动编号）
- 小说列表分页

#### 3. AI功能
- AI续写（基于DashScope API）
- 增加用户选项，用户可以决定AI续写或者修改时是否读取向量数据
- 内容润色
- 长度控制（短/中/长）

#### 4. 向量化存储
- 章节内容向量化（text-embedding-v4）
- pgvector集成
- 相似内容检索

#### 5. 前端界面
- 登录/注册页面
- 小说列表页面
- 小说详情页面
- 章节编辑页面
- AI交互界面
- 小说阅读页面

### ⚠️ 当前问题

#### 1. 用户权限系统
- **问题**: 当前硬编码`author_id=1`，导致多用户无法正常工作
- **影响**: 所有API端点都使用硬编码的author_id，无法区分不同用户

#### 2. 公开阅读功能
- **问题**: `is_public`字段已存在但未完全启用
- **影响**: 用户无法控制小说的公开/私有状态

#### 3. AI上下文集成
- **问题**: AI续写未充分利用向量数据库
- **影响**: 无法提供上下文相关的AI续写结果

#### 4. 团队协作
- **问题**: 仅支持单用户
- **影响**: 缺少团队管理和协作编辑功能

### ⚠️ 需要完善的功能

#### 1. 用户权限系统
- **问题**: 当前硬编码`author_id=1`
- **解决方案**: 使用`get_current_user`依赖注入

#### 2. 公开阅读功能
- **问题**: 缺少小说公开/私有控制
- **解决方案**: 添加`is_public`字段和权限控制
- **现状**: `is_public`字段已在数据库模型中定义，但未完全启用

#### 3. AI上下文集成
- **问题**: AI续写未充分利用向量数据库
- **解决方案**: 集成向量检索到提示词

#### 4. 团队协作
- **问题**: 仅支持单用户
- **解决方案**: 添加团队管理和协作编辑
- **现状**: 需要添加团队管理功能

## MVP需求分析

### 核心功能要求
1. **用户注册/登录**
   - 可以使用邮箱作为用户名
   - 密码复杂度可配置

2. **小说/章节管理**
   - 单用户新增小说和章节
   - 章节保存至数据库

3. **AI交互**
   - 实现交替续写、修改
   - 增加用户选项，由用户决定AI参与时是否读取向量数据库
   - 支持AI润色和故事建议
   - 续写、修改时

4. **向量化存储**
   - 不论用户是否选择了AI参与时是否读取向量数据库，都需要向量化后保存
   - 章节内容向量化后保存
   - 保持AI创作一致性

5. **公开阅读**
   - 作者可选择公开小说
   - 其他用户可阅读公开章节

## 六阶段实施计划（含数据库设计审查）

### 第零阶段：数据库设计与审查 (0.5-1天)
**目标**：确保数据库结构一次性满足所有功能需求
1. **审查现有数据库模型** - 检查novel.py, user.py, vector.py的完整性
2. **识别缺失的表和字段** - 根据五阶段功能需求找出缺失部分
3. **设计协作相关表** - 团队表(Team)、团队成员表(TeamMember)、权限表
4. **设计评论反馈表** - 评论表(Comment)、反馈表(Feedback)
5. **设计人物关系存储** - 人物表(Character)、关系表(Relationship)
6. **设计开关设置存储** - 用户设置表(UserSetting)或小说设置表
7. **更新SQL迁移脚本** - 确保所有表结构一次性创建
8. **验证数据模型关系** - 确保所有外键和关系正确

### 第一阶段：用户系统与基础功能 (1-2天)
1. **完善用户注册系统** - 验证注册接口的健壮性，添加必要的验证和错误处理
2. **完善用户登录系统** - 验证登录接口功能，确保JWT令牌正确生成和验证
3. **修复用户权限系统** - 移除硬编码的`author_id=1`，使用`get_current_user`依赖注入
4. **实现公开阅读功能** - 添加`is_public`字段和权限控制，完善前端公开小说页面
5. **完善前端路由和导航** - 确保所有页面可访问
6. **测试基础API端点** - 验证用户系统和权限修复后的功能

### 第二阶段：核心AI功能（非向量） (1-2天)
1. **完善AI聊天助理** - 提供基础对话和写作建议
2. **添加AI润色功能优化** - 优化现有基础润色功能
3. **添加"是否向量化"开关** - 优前端界面增加开关控制（默认关闭），使用第零阶段设计的设置表
4. **修改AI接口支持开关** - 后端支持开关控制，关闭时不使用向量检索

### 第三阶段：向量数据库集成 (1-2天)

1. **集成向量检索到AI续写** - 当开关打开时使用向量数据库提供上下文
2. **优化向量存储性能** - 向量检索和存储优化
3. **数据库初始化脚本优化** - 确保pgvector扩展已启用并优化配置
4. **验证向量数据库模型** - 确认向量相关字段正确映射

### 第四阶段：协作功能 (2-3天)

1. **添加团队管理功能** - 创建团队、邀请成员，使用第零阶段设计的表
2. **实现协作编辑机制** - 实时或异步协作，使用权限控制
3. **添加评论和反馈系统** - 团队成员互动，使用第零阶段设计的表
4. **权限分级管理** - 所有者、编辑者、读者权限，使用第零阶段设计的权限表

### 第五阶段：优化与发布 (1-2天)

1. **响应式设计优化** - 确保移动端友好
2. **实现人物关系图生成** - 基于文本分析，使用第零阶段设计的数据表
3. **添加加载状态和错误处理** - 提升用户体验
4. **性能优化** - 包括向量检索和AI调用优化
5. **完整测试套件** - 单元测试和集成测试
6. **用户测试和反馈收集** - 邀请测试用户验证功能


## 技术债务

### 1. 代码结构
- API端点需要统一错误处理
- 服务层需要更好的抽象
- 前端组件需要复用优化

### 2. 性能考虑
- 向量检索需要索引优化
- AI API调用需要缓存机制
- 数据库查询需要优化

### 3. 安全性
- 输入验证需要加强
- API速率限制
- 敏感数据保护

## 风险评估

1. **AI API成本** - DashScope API调用可能产生费用
2. **向量数据库性能** - pgvector在大数据量时可能需要优化
3. **并发协作** - 多人同时编辑需要冲突解决机制

## 快速启动

```bash
# 后端
cd backend
pip install -r requirements.txt
python -m app.main

# 前端
npm install
quasar dev
```

## 进度跟踪

**当前进度**: 基础框架完成，核心功能实现约70%

**下一步重点**: 
1. 修复用户权限系统
2. 实现公开阅读功能
3. 集成向量检索

## 标签
- enhancement
- documentation
- planning
